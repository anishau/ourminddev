<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hearing Voices | ourmind.care</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap">
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.supabase = createClient(
            'https://ykifhipjmptpqswsblmi.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZoaXBqbXB0cHFzd3NibG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5ODA2NTIsImV4cCI6MjA1NzU1NjY1Mn0.gvDlgrJHrdT6vWMBQaK8XirtlKSVDX5BvVrMreOfjpk'
        )
    </script>
    <style>
        :root {
            --text: #333;
            --bg: #fff;
            --accent: #eee;
            --accent-2: rgba(171, 195, 163, 0.7);
            --accent-3: rgba(173, 216, 230, 0.7);
            --accent-4: rgba(230, 190, 230, 0.7);
            --footer-text: #666;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--accent);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-links a {
            color: inherit;
            text-decoration: none;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        h1, h2, h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        h1 {
            font-size: 2rem;
        }

        h2 {
            font-size: 1.5rem;
        }

        h3 {
            font-size: 1.25rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Auth styles */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-modal.visible {
            display: flex;
        }

        .auth-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-form a {
            color: inherit;
            text-decoration: underline;
            cursor: pointer;
        }

        .auth-form a:hover {
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
        }

        button {
            background: var(--text);
            color: var(--bg);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: inherit;
        }

        button:hover {
            opacity: 0.9;
        }

        .site-footer {
            margin-top: 4rem;
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--accent);
            color: var(--footer-text);
        }

        /* Content sections */
        .content-grid {
            display: grid;
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .content-card {
            padding: 1.5rem;
            border: 1px solid var(--accent);
            text-decoration: none;
            color: inherit;
            border-radius: 2px;
        }

        .content-card:hover {
            background: var(--accent);
        }

        .content-card h2 {
            margin: 0;
        }

        .content-card p {
            margin: 0.5rem 0 0 0;
            opacity: 0.8;
        }

        /* Exercise sections */
        .key-message {
            background: var(--accent);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
            font-style: italic;
        }

        .press-pause, .activate-curiosity {
            background: var(--accent);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
        }

        .press-pause-section, .activate-curiosity-section {
            background: var(--accent-2);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        .activate-curiosity-section {
            background: var(--accent-3);
        }

        .section-content {
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-content h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .section-content > p {
            margin-bottom: 0.1rem;
        }

        .journal-entry {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 0.25rem;
        }

        .journal-entry textarea {
            width: 100%;
            min-height: 200px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-family: inherit;
            background: white;
            font-size: 1rem;
            line-height: 1.5;
        }

        .past-entries {
            max-height: 150px;
            overflow-y: auto;
            padding-right: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .past-entries-sidebar {
            position: sticky;
            top: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .past-entries-sidebar h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1rem;
            color: var(--footer-text);
        }

        .past-entry {
            padding: 1rem;
            margin: 0.5rem 0;
            background: var(--accent);
            border-radius: 4px;
            position: relative;
        }

        .entry-date {
            font-size: 0.875rem;
            color: var(--footer-text);
            margin-bottom: 0.5rem;
        }

        .entry-content {
            white-space: pre-wrap;
            min-height: 1em;
            padding: 0.5rem;
            border: 1px solid transparent;
            font-size: 1rem;
            line-height: 1.5;
        }

        .entry-content:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            padding: 0.5rem;
        }

        .entry-actions {
            margin-top: 0.5rem;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .entry-actions button {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .entry-actions button:hover {
            opacity: 1;
        }

        .delete-edit {
            background: #dc3545;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .press-pause-section, .activate-curiosity-section {
                grid-template-columns: 1fr;
            }
            
            .past-entries-sidebar {
                position: static;
                margin-top: 1rem;
            }
        }

        /* Keep the textarea styles as they're used by hearing-voices.md and paranoia.md */
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="nav-links">
                <a href="/" class="logo">ourmind.care</a>
                <a href="/hearing-voices">Hearing Voices</a>
                <a href="/paranoia">Paranoia</a>
                <a href="/field_notes">Field Notes</a>
            </div>
            <div class="auth-nav">
                <button id="authButton" class="auth-button">Sign In</button>
                <div id="authModal" class="auth-modal">
                    <div id="authContainer"></div>
                </div>
            </div>
        </nav>

        
        <h1 class="title">
            Hearing Voices
        </h1>
        

        <div class="key-message">It's to be expected that the following exercises may be tricky at various points. Practice is required, journaling is recommended, alongside therapy and other supportive relationships.</div>
<div class="press-pause">
    <h2>Press Pause</h2>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Strengthen Insight</h3>
What helped you notice you were/are hearing a voice? What helps you accept that you hear sounds others do not?</p>
<p><div class="journal-entry" data-section="press_pause" data-question="strengthen-insight" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="strengthen-insight" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Mindfulness</h3>
If you are experiencing a distressing voice, is it possible for you to try and pull your focus to your breathing for as long as you can?</p>
<p><div class="journal-entry" data-section="press_pause" data-question="mindfulness" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="mindfulness" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Distress Tolerance</h3>
Is it possible for you to experience the distressing messages from the voice without needing to react? The <a href="https://dbt.tools/distress_tolerance/index.php">skills discussed here</a> will likely be helpful.</p>
<p><div class="journal-entry" data-section="press_pause" data-question="distress-tolerance" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="distress-tolerance" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Imagination</h3>
Can you imagine a shell between you and your voices? A membrane they could bounce off of that allows you to watch them but not to have to engage them? Like you're watching waves crash in the ocean. What does this boundary feel like?</p>
<p><div class="journal-entry" data-section="press_pause" data-question="imagination" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="imagination" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Your Own Idea</h3>
What feels like it would help you create a sense of safety from which to get curious about your voices?</p>
<p><div class="journal-entry" data-section="press_pause" data-question="your-own-idea" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="your-own-idea" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
</div>
<div class="activate-curiosity">
    <h2>Activate Curiosity</h2>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>Where do the voices come from?</h3>
Can you identify familiar sounds or themes in the voices?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="where-do-the-voices-come-from" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="where-do-the-voices-come-from" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>Why do the voices come from that place?</h3>
Voices are one way the body tries to protect itself. Can you wonder about why your body chooses this specific way to take care of you?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="why-do-the-voices-come-from-that-place" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="why-do-the-voices-come-from-that-place" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>Acceptance</h3>
Can you cherish the hurt in the self the voices call back to?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="acceptance" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="acceptance" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>What other questions or exercises can help you?</h3>
What other practices or reflections would help you better live with your voices?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="what-other-questions-or-exercises-can-help-you" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="what-other-questions-or-exercises-can-help-you" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
</div>
<script type="module">
    // Get data from front matter
    const pressPause = [{"title":"Strengthen Insight","content":"What helped you notice you were/are hearing a voice? What helps you accept that you hear sounds others do not?\n"},{"title":"Mindfulness","content":"If you are experiencing a distressing voice, is it possible for you to try and pull your focus to your breathing for as long as you can?\n"},{"title":"Distress Tolerance","content":"Is it possible for you to experience the distressing messages from the voice without needing to react? The <a href=\"https://dbt.tools/distress_tolerance/index.php\">skills discussed here</a> will likely be helpful.\n"},{"title":"Imagination","content":"Can you imagine a shell between you and your voices? A membrane they could bounce off of that allows you to watch them but not to have to engage them? Like you're watching waves crash in the ocean. What does this boundary feel like?\n"},{"title":"Your Own Idea","content":"What feels like it would help you create a sense of safety from which to get curious about your voices?\n"}];
    const activateCuriosity = [{"title":"Where do the voices come from?","content":"Can you identify familiar sounds or themes in the voices?\n"},{"title":"Why do the voices come from that place?","content":"Voices are one way the body tries to protect itself. Can you wonder about why your body chooses this specific way to take care of you?\n"},{"title":"Acceptance","content":"Can you cherish the hurt in the self the voices call back to?\n"},{"title":"What other questions or exercises can help you?","content":"What other practices or reflections would help you better live with your voices?\n"}];

    // Debug Supabase connection
    console.log('Checking Supabase connection...');
    const { data: testData, error: testError } = await supabase
        .from('prompts')
        .select('*')
        .limit(1);
    
    if (testError) {
        console.error('Supabase connection error:', testError);
    } else {
        console.log('Supabase connection successful, sample data:', testData);
    }

    // Check if user is authenticated
    const { data: { session } } = await supabase.auth.getSession()
    
    // Store prompt IDs
    let promptIds = {};

    // Show journal entries if signed in
    if (session) {
        // First, get or create prompts
        async function getPrompts() {
            try {
                console.log('Starting getOrCreatePrompts');
                // Get all prompts for this page at once
                const { data: prompts, error } = await supabase
                    .from('prompts')
                    .select('*')
                    .eq('page_type', 'hearing_voices')
                    .order('section_type', { ascending: true })
                    .order('display_order', { ascending: true });
                
                if (error) {
                    console.error('Error fetching prompts:', error);
                    return;
                }
                
                console.log('All prompts:', prompts);
                
                // Map prompts to their titles
                prompts.forEach(prompt => {
                    // Only take the first prompt if there are duplicates
                    if (!promptIds[prompt.title]) {
                        promptIds[prompt.title] = prompt.id;
                    }
                });
                
                console.log('Mapped promptIds:', promptIds);
                
            } catch (error) {
                console.error('Error in getOrCreatePrompts:', error);
                console.error('Stack:', error.stack);
            }
        }

        // Wait for prompts to be ready before showing UI
        await getPrompts();
        console.log('Prompts loaded:', promptIds);

        // Show both journal entries and sidebars for signed-in users
        document.querySelectorAll('.journal-entry').forEach(entry => {
            entry.style.display = 'block';
            console.log('Showing journal entry:', entry.dataset.question);
        });
        document.querySelectorAll('.past-entries-sidebar').forEach(sidebar => {
            sidebar.style.display = 'block';
            console.log('Showing sidebar:', sidebar.dataset.question);
        });

        // Double check that elements exist
        const journalEntries = document.querySelectorAll('.journal-entry');
        const sidebars = document.querySelectorAll('.past-entries-sidebar');
        console.log(`Found ${journalEntries.length} journal entries and ${sidebars.length} sidebars`);

        // Load past entries
        async function loadEntries() {
            const { data: entries, error } = await supabase
                .from('responses')
                .select('*')
                .eq('user_id', session.user.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading entries:', error);
                return;
            }

            // Clear existing entries before loading
            document.querySelectorAll('.past-entries').forEach(container => {
                container.innerHTML = '';
            });

            entries.forEach(entry => {
                const matchingPrompt = Object.entries(promptIds).find(([title, id]) => id === entry.prompt_id);
                if (!matchingPrompt) {
                    console.error('Could not find prompt for prompt_id:', entry.prompt_id);
                    return;
                }
                const [promptTitle, promptId] = matchingPrompt;
                
                const section = pressPause.find(item => item.title === promptTitle) 
                    ? 'press_pause' 
                    : 'activate_curiosity';
                
                const questionSlug = promptTitle.toLowerCase().replace(/\s+/g, '-');
                
                // Try different selector combinations
                let container = null;
                const selectors = [
                    `[data-section="${section}"][data-question="${questionSlug}"] .past-entries-sidebar .past-entries`,
                    `.past-entries-sidebar[data-section="${section}"][data-question="${questionSlug}"] .past-entries`,
                    `.journal-entry[data-section="${section}"][data-question="${questionSlug}"] ~ .past-entries-sidebar .past-entries`
                ];
                
                for (const selector of selectors) {
                    container = document.querySelector(selector);
                    if (container) break;
                }
                
                console.log('Looking for container with:', {
                    promptTitle,
                    questionSlug,
                    section,
                    triedSelectors: selectors,
                    allContainers: Array.from(document.querySelectorAll('.past-entries')).map(el => ({
                        section: el.closest('[data-section]')?.dataset.section,
                        question: el.closest('[data-question]')?.dataset.question,
                        html: el.outerHTML.substring(0, 100) + '...'
                    })),
                    found: !!container
                });

                if (container) {
                    const entryEl = document.createElement('div');
                    entryEl.className = 'past-entry';
                    entryEl.dataset.entryId = entry.id;
                    entryEl.innerHTML = `
                        <div class="entry-date">${new Date(entry.created_at).toLocaleDateString()}</div>
                        <div class="entry-content" contenteditable="true">${escapeHtml(entry.content)}</div>
                        <div class="entry-actions">
                            <button class="save-edit" style="display: none;">Save</button>
                            <button class="cancel-edit" style="display: none;">Cancel</button>
                            <button class="delete-edit" style="display: none;">Delete</button>
                        </div>
                    `;

                    // Store original content for cancel functionality
                    const contentEl = entryEl.querySelector('.entry-content');
                    let originalContent = entry.content;
                    
                    // Show/hide buttons when editing
                    contentEl.addEventListener('focus', () => {
                        entryEl.querySelector('.save-edit').style.display = 'inline-block';
                        entryEl.querySelector('.cancel-edit').style.display = 'inline-block';
                        entryEl.querySelector('.delete-edit').style.display = 'inline-block';
                    });
                    
                    contentEl.addEventListener('blur', (e) => {
                        // Don't hide if clicking the action buttons
                        if (e.relatedTarget && e.relatedTarget.closest('.entry-actions')) {
                            return;
                        }
                        // Hide buttons if clicking outside
                        if (!e.relatedTarget || !e.relatedTarget.closest('.past-entry')) {
                            setTimeout(() => {
                                if (!document.activeElement.closest('.past-entry')) {
                                    entryEl.querySelector('.save-edit').style.display = 'none';
                                    entryEl.querySelector('.cancel-edit').style.display = 'none';
                                    entryEl.querySelector('.delete-edit').style.display = 'none';
                                }
                            }, 100);
                        }
                    });

                    // Save edit
                    entryEl.querySelector('.save-edit').addEventListener('click', async () => {
                        const newContent = contentEl.textContent;
                        const { error } = await supabase
                            .from('responses')
                            .update({ content: newContent })
                            .eq('id', entry.id);
                            
                        if (error) {
                            console.error('Error updating entry:', error);
                            contentEl.textContent = originalContent;
                        } else {
                            originalContent = newContent;
                            entryEl.querySelector('.save-edit').style.display = 'none';
                            entryEl.querySelector('.cancel-edit').style.display = 'none';
                            entryEl.querySelector('.delete-edit').style.display = 'none';
                        }
                    });
                    
                    // Cancel edit
                    entryEl.querySelector('.cancel-edit').addEventListener('click', () => {
                        contentEl.textContent = originalContent;
                        entryEl.querySelector('.save-edit').style.display = 'none';
                        entryEl.querySelector('.cancel-edit').style.display = 'none';
                        entryEl.querySelector('.delete-edit').style.display = 'none';
                    });

                    // Delete entry
                    entryEl.querySelector('.delete-edit').addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this entry?')) {
                            const { error } = await supabase
                                .from('responses')
                                .delete()
                                .eq('id', entry.id);
                                
                            if (error) {
                                console.error('Error deleting entry:', error);
                            } else {
                                entryEl.remove();
                            }
                        }
                    });

                    container.appendChild(entryEl);
                } else {
                    console.error('Could not find container for entry:', {
                        promptTitle,
                        questionSlug,
                        section,
                        triedSelectors: selectors,
                        entry
                    });
                }
            });
        }

        // Save new entry
        async function saveEntry(section, question, content) {
            console.log('saveEntry called with:', { section, question, content });
            console.log('Looking up prompt ID for:', question);
            console.log('Available promptIds:', promptIds);
            const promptId = promptIds[question];  // Use original case
            if (!promptId) {
                console.error('No prompt ID found for question:', question);
                console.error('Available questions:', Object.keys(promptIds));
                return false;
            }

            console.log('Attempting to save to responses table:', { 
                content,
                prompt_id: promptId,
                user_id: session.user.id 
            });

            const { data, error } = await supabase
                .from('responses')
                .insert([
                    { 
                        content: content,
                        prompt_id: promptId,
                        user_id: session.user.id
                    }
                ])
                .select();

            if (error) {
                console.error('Error saving entry:', {
                    message: error.message,
                    details: error.details,
                    hint: error.hint,
                    code: error.code
                });
                return false;
            }

            console.log('Entry saved successfully:', data);
            // Add new entry to UI immediately
            const questionSlug = question.toLowerCase().replace(/\s+/g, '-');
            const pastEntriesContainer = document.querySelector(
                `[data-section="${section}"][data-question="${questionSlug}"] .past-entries-sidebar .past-entries`
            );
            
            if (pastEntriesContainer) {
                const entryEl = document.createElement('div');
                entryEl.className = 'past-entry';
                entryEl.dataset.entryId = data[0].id;
                entryEl.innerHTML = `
                    <div class="entry-date">${new Date().toLocaleDateString()}</div>
                    <div class="entry-content" contenteditable="true">${escapeHtml(content)}</div>
                    <div class="entry-actions">
                        <button class="save-edit" style="display: none;">Save</button>
                        <button class="cancel-edit" style="display: none;">Cancel</button>
                        <button class="delete-edit" style="display: none;">Delete</button>
                    </div>
                `;
                
                // Add the same edit functionality as in loadEntries
                const contentEl = entryEl.querySelector('.entry-content');
                let originalContent = content;
                
                contentEl.addEventListener('focus', () => {
                    entryEl.querySelector('.save-edit').style.display = 'inline-block';
                    entryEl.querySelector('.cancel-edit').style.display = 'inline-block';
                    entryEl.querySelector('.delete-edit').style.display = 'inline-block';
                });
                
                contentEl.addEventListener('blur', (e) => {
                    // Don't hide if clicking the action buttons
                    if (e.relatedTarget && e.relatedTarget.closest('.entry-actions')) {
                        return;
                    }
                    // Hide buttons if clicking outside
                    if (!e.relatedTarget || !e.relatedTarget.closest('.past-entry')) {
                        setTimeout(() => {
                            if (!document.activeElement.closest('.past-entry')) {
                                entryEl.querySelector('.save-edit').style.display = 'none';
                                entryEl.querySelector('.cancel-edit').style.display = 'none';
                                entryEl.querySelector('.delete-edit').style.display = 'none';
                            }
                        }, 100);
                    }
                });
                
                entryEl.querySelector('.save-edit').addEventListener('click', async () => {
                    const newContent = contentEl.textContent;
                    const { error } = await supabase
                        .from('responses')
                        .update({ content: newContent })
                        .eq('id', data[0].id);
                        
                    if (error) {
                        console.error('Error updating entry:', error);
                        contentEl.textContent = originalContent;
                    } else {
                        originalContent = newContent;
                        entryEl.querySelector('.save-edit').style.display = 'none';
                        entryEl.querySelector('.cancel-edit').style.display = 'none';
                        entryEl.querySelector('.delete-edit').style.display = 'none';
                    }
                });
                
                entryEl.querySelector('.cancel-edit').addEventListener('click', () => {
                    contentEl.textContent = originalContent;
                    entryEl.querySelector('.save-edit').style.display = 'none';
                    entryEl.querySelector('.cancel-edit').style.display = 'none';
                    entryEl.querySelector('.delete-edit').style.display = 'none';
                });
                
                // Insert at the top of the list
                pastEntriesContainer.insertBefore(entryEl, pastEntriesContainer.firstChild);
            }

            return true;
        }

        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add event listeners to save buttons
        document.querySelectorAll('.save-entry').forEach(button => {
            button.addEventListener('click', async () => {
                const journalEntry = button.closest('.journal-entry')
                const textarea = journalEntry.querySelector('textarea')
                const section = journalEntry.dataset.section
                // Find the original title from the slug
                const questionSlug = journalEntry.dataset.question
                const items = section === 'press_pause' ? pressPause : activateCuriosity
                const originalQuestion = items.find(item => item.title.toLowerCase().replace(/\s+/g, '-') === questionSlug)?.title
                
                if (!originalQuestion) {
                    console.error('Could not find original question for slug:', questionSlug)
                    return
                }

                const content = textarea.value.trim()

                if (content) {
                    const success = await saveEntry(section, originalQuestion, content)
                    if (success) {
                        // Add new entry to UI immediately
                        const pastEntriesContainer = document.querySelector(`[data-section="${section}"][data-question="${questionSlug}"] .past-entries-sidebar .past-entries`)
                        if (pastEntriesContainer) {
                            const entryEl = document.createElement('div')
                            entryEl.className = 'past-entry'
                            entryEl.innerHTML = `
                                <div class="entry-date">${new Date().toLocaleDateString()}</div>
                                <div class="entry-content">${escapeHtml(content)}</div>
                            `
                            // Insert at the top of the list
                            pastEntriesContainer.insertBefore(entryEl, pastEntriesContainer.firstChild)
                            textarea.value = ''
                        }
                    }
                }
            })
        })

        // Load entries on page load
        loadEntries()
    }
</script>

    </div>
    
    <footer class="site-footer">
        <span class="handshake">ü§ù</span>
        <p>a <a href="https://www.mutua.nyc">mutua.nyc</a> collaboration</p>
        <span class="handshake">ü§ù</span>
    </footer>

    <script type="module">
        import { AuthUI } from '/js/auth.js'
        
        const authButton = document.getElementById('authButton')
        const authModal = document.getElementById('authModal')
        const authContainer = document.getElementById('authContainer')
        
        let auth = null

        if (authButton) {
            authButton.addEventListener('click', async (e) => {
                e.preventDefault()
                e.stopPropagation()

                // If user is signed in, sign them out
                if (authButton.textContent === 'Sign Out') {
                    await supabase.auth.signOut()
                    authButton.textContent = 'Sign In'
                    // Don't show the auth modal after signing out
                    return
                }

                // Show sign in modal
                if (authModal) {
                    authModal.classList.add('visible')
                    authModal.classList.remove('hidden')
                    if (!auth) {
                        auth = AuthUI({ container: authContainer })
                    }
                }
            })
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (authModal && !authModal.contains(e.target) && !authButton.contains(e.target)) {
                authModal.classList.remove('visible')
                authModal.classList.add('hidden')
            }
        })

        // Prevent clicks inside modal from closing it
        if (authModal) {
            authModal.addEventListener('click', (e) => {
                e.stopPropagation()
            })
        }

        // Check auth state on page load and changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                // User is signed in
                // Hide the auth modal when signed in
                authModal.classList.remove('visible')
                authModal.classList.add('hidden')
                authButton.textContent = 'Sign Out'
                // Redirect to hearing voices page if on home page
                if (window.location.pathname === '/') {
                    window.location.href = '/hearing-voices';
                }
            } else {
                // User is signed out
                // Clear the auth UI when signed out
                auth = null
                authContainer.innerHTML = ''
                authButton.textContent = 'Sign In'
            }
        })

        // Initial check
        const { data: { session } } = await supabase.auth.getSession()
        if (session) {
            authButton.textContent = 'Sign Out'
            // Redirect to hearing voices page if on home page
            if (window.location.pathname === '/') {
                window.location.href = '/hearing-voices';
            }
        }
    </script>
</body>
</html> 