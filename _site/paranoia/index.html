<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paranoia | ourmind.care</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap">
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.supabase = createClient(
            'https://ykifhipjmptpqswsblmi.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlraWZoaXBqbXB0cHFzd3NibG1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5ODA2NTIsImV4cCI6MjA1NzU1NjY1Mn0.gvDlgrJHrdT6vWMBQaK8XirtlKSVDX5BvVrMreOfjpk'
        )
    </script>
    <style>
        :root {
            --text: #333;
            --bg: #fff;
            --accent: #eee;
            --accent-2: rgba(171, 195, 163, 0.7);
            --accent-3: rgba(173, 216, 230, 0.7);
            --accent-4: rgba(230, 190, 230, 0.7);
            --footer-text: #666;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: var(--text);
            background: var(--bg);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--accent);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-links a {
            color: inherit;
            text-decoration: none;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        h1, h2, h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        h1 {
            font-size: 2rem;
        }

        h2 {
            font-size: 1.5rem;
        }

        h3 {
            font-size: 1.25rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Auth styles */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-modal.visible {
            display: flex;
        }

        .auth-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-form a {
            color: inherit;
            text-decoration: underline;
            cursor: pointer;
        }

        .auth-form a:hover {
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
        }

        button {
            background: var(--text);
            color: var(--bg);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: inherit;
        }

        button:hover {
            opacity: 0.9;
        }

        .site-footer {
            margin-top: 4rem;
            padding: 2rem;
            text-align: center;
            border-top: 1px solid var(--accent);
            color: var(--footer-text);
        }

        /* Content sections */
        .content-grid {
            display: grid;
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .content-card {
            padding: 1.5rem;
            border: 1px solid var(--accent);
            text-decoration: none;
            color: inherit;
            border-radius: 2px;
        }

        .content-card:hover {
            background: var(--accent);
        }

        .content-card h2 {
            margin: 0;
        }

        .content-card p {
            margin: 0.5rem 0 0 0;
            opacity: 0.8;
        }

        /* Exercise sections */
        .key-message {
            background: var(--accent);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
            font-style: italic;
        }

        .press-pause, .activate-curiosity {
            background: var(--accent);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
        }

        .press-pause-section, .activate-curiosity-section {
            background: var(--accent-2);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        .activate-curiosity-section {
            background: var(--accent-3);
        }

        .section-content {
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-content h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .section-content > p {
            margin-bottom: 0.1rem;
        }

        .journal-entry {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 0.25rem;
        }

        .journal-entry textarea {
            width: 100%;
            min-height: 200px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-family: inherit;
            background: white;
            font-size: 1rem;
            line-height: 1.5;
        }

        .past-entries {
            max-height: 150px;
            overflow-y: auto;
            padding-right: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .past-entries-sidebar {
            position: sticky;
            top: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .past-entries-sidebar h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1rem;
            color: var(--footer-text);
        }

        .past-entry {
            padding: 1rem;
            margin: 0.5rem 0;
            background: var(--accent);
            border-radius: 4px;
            position: relative;
        }

        .entry-date {
            font-size: 0.875rem;
            color: var(--footer-text);
            margin-bottom: 0.5rem;
        }

        .entry-content {
            white-space: pre-wrap;
            min-height: 1em;
            padding: 0.5rem;
            border: 1px solid transparent;
            font-size: 1rem;
            line-height: 1.5;
        }

        .entry-content:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            padding: 0.5rem;
        }

        .entry-actions {
            margin-top: 0.5rem;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .entry-actions button {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .entry-actions button:hover {
            opacity: 1;
        }

        .delete-edit {
            background: #dc3545;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .press-pause-section, .activate-curiosity-section {
                grid-template-columns: 1fr;
            }
            
            .past-entries-sidebar {
                position: static;
                margin-top: 1rem;
            }
        }

        /* Keep the textarea styles as they're used by hearing-voices.md and paranoia.md */
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <div class="nav-links">
                <a href="/" class="logo">ourmind.care</a>
                <a href="/hearing-voices">Hearing Voices</a>
                <a href="/paranoia">Paranoia</a>
                <a href="/field_notes">Field Notes</a>
            </div>
            <div class="auth-nav">
                <button id="authButton" class="auth-button">Sign In</button>
                <div id="authModal" class="auth-modal">
                    <div id="authContainer"></div>
                </div>
            </div>
        </nav>

        
        <h1 class="title">
            Paranoia
        </h1>
        

        <div class="key-message">It's to be expected that the following excercises may be tricky at various points. Practice is required, journaling is recommended, alongside therapy and other supportive relationships.</div>
<div class="press-pause">
    <h2>Press Pause</h2>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Strengthen Insight</h3>
When you are wondering if others are trying to hurt you, don't like you, etc. what helps you consider that this may be paranoia?</p>
<p><div class="journal-entry" data-section="press_pause" data-question="strengthen-insight" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="strengthen-insight" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Stay With The Feeling</h3>
When experiencing a fear that others may want to hurt you, don't like you, etc., is it possible to teach yourself to stay with that feeling without acting on it?
Skills like <a href="https://dbt.tools/distress_tolerance/index.php">distress tolerance</a> may be especially useful.</p>
<p><div class="journal-entry" data-section="press_pause" data-question="stay-with-the-feeling" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="stay-with-the-feeling" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Broaden Your Perspective</h3>
Once you can find some presence of mind within that space, is it possible to consider alternatives? That while people may be trying to hurt you, they also may be trying to help you? Or they may be neutral towards you.
Try and hold room for this breadth of perspective as much as you can.</p>
<p><div class="journal-entry" data-section="press_pause" data-question="broaden-your-perspective" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="broaden-your-perspective" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Be With Ambiguity</h3>
Alternately, can you backtrack for a second, and recognize what situation caused you to feel paranoid?
Often, paranoia is caused by stimuli that feel ambiguous in some way. Is it possible for you to sit with the ambiguity itself, without jumping to conclusions about it? What makes that hard?</p>
<p><div class="journal-entry" data-section="press_pause" data-question="be-with-ambiguity" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="be-with-ambiguity" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="press-pause-section">
<div class="section-content">
<h3>Your Own Idea</h3>
What feels like it would help you create a sense of safety from which to get curious about your paranoia?</p>
<p><div class="journal-entry" data-section="press_pause" data-question="your-own-idea" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="press_pause" data-question="your-own-idea" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
</div>
<div class="activate-curiosity">
    <h2>Activate Curiosity</h2>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>Where does the paranoia locate itself?</h3>
Why do you think that people are looking at you, talking about you, wanting to hurt you, etc? Are there aspects of yourself that make you self-conscious or embarrassed?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="where-does-the-paranoia-locate-itself" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="where-does-the-paranoia-locate-itself" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>Where are you vulnerable to paranoia?</h3>
Why do these parts of yourself or your presentation make you self conscious, embarrassed, or hateful towards yourself?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="where-are-you-vulnerable-to-paranoia" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="where-are-you-vulnerable-to-paranoia" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>Acceptance</h3>
Can you accept these aspects of yourself with pride and love for your uniqueness?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="acceptance" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="acceptance" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
<p><div class="activate-curiosity-section">
<div class="section-content">
<h3>What other questions or exercises can help you?</h3>
What other practices or reflections would help you better live with your paranoia?</p>
<p><div class="journal-entry" data-section="activate_curiosity" data-question="what-other-questions-or-exercises-can-help-you" style="display: none">
<textarea placeholder="Write your reflections here..."></textarea>
<button class="save-entry">Save</button>
</div>
</div>
<div class="past-entries-sidebar" data-section="activate_curiosity" data-question="what-other-questions-or-exercises-can-help-you" style="display: none">
<h4>Previous Entries</h4>
<div class="past-entries"></div>
</div>
</div></p>
</div>
<script type="module">
    // Get data from front matter
    const pressPause = [{"title":"Strengthen Insight","content":"When you are wondering if others are trying to hurt you, don't like you, etc. what helps you consider that this may be paranoia?\n"},{"title":"Stay With The Feeling","content":"When experiencing a fear that others may want to hurt you, don't like you, etc., is it possible to teach yourself to stay with that feeling without acting on it?\nSkills like <a href=\"https://dbt.tools/distress_tolerance/index.php\">distress tolerance</a> may be especially useful.\n"},{"title":"Broaden Your Perspective","content":"Once you can find some presence of mind within that space, is it possible to consider alternatives? That while people may be trying to hurt you, they also may be trying to help you? Or they may be neutral towards you.\nTry and hold room for this breadth of perspective as much as you can.\n"},{"title":"Be With Ambiguity","content":"Alternately, can you backtrack for a second, and recognize what situation caused you to feel paranoid?\nOften, paranoia is caused by stimuli that feel ambiguous in some way. Is it possible for you to sit with the ambiguity itself, without jumping to conclusions about it? What makes that hard?\n"},{"title":"Your Own Idea","content":"What feels like it would help you create a sense of safety from which to get curious about your paranoia?\n"}];
    const activateCuriosity = [{"title":"Where does the paranoia locate itself?","content":"Why do you think that people are looking at you, talking about you, wanting to hurt you, etc? Are there aspects of yourself that make you self-conscious or embarrassed?\n"},{"title":"Where are you vulnerable to paranoia?","content":"Why do these parts of yourself or your presentation make you self conscious, embarrassed, or hateful towards yourself?\n"},{"title":"Acceptance","content":"Can you accept these aspects of yourself with pride and love for your uniqueness?\n"},{"title":"What other questions or exercises can help you?","content":"What other practices or reflections would help you better live with your paranoia?\n"}];

    // Check if user is authenticated
    const { data: { session } } = await supabase.auth.getSession()
    
    // Store prompt IDs
    let promptIds = {};

    // Show journal entries if signed in
    if (session) {
        // First, get or create prompts
        async function getOrCreatePrompts() {
            try {
                console.log('Starting getOrCreatePrompts');
                for (const section of ['press_pause', 'activate_curiosity']) {
                    const items = section === 'press_pause' ? pressPause : activateCuriosity;
                    
                    for (const item of items) {
                        // Check if prompt exists
                        const { data, error } = await supabase
                            .from('prompts')
                            .select('id')
                            .eq('page_type', 'paranoia')
                            .eq('section_type', section)
                            .eq('content', item.content)
                            .single();
                        
                        if (error) {
                            console.error('Error finding prompt:', error);
                            continue;
                        } else if (data) {
                            promptIds[item.title] = data.id;
                            console.log(`Found prompt ID for "${item.title}":`, data.id);
                        }
                    }
                }
            } catch (error) {
                console.error('Error in getOrCreatePrompts:', error);
            }
        }

        // Wait for prompts to be ready before showing UI
        await getOrCreatePrompts();

        document.querySelectorAll('.journal-entry').forEach(entry => {
            entry.style.display = 'block';
        })
        document.querySelectorAll('.past-entries-sidebar').forEach(sidebar => {
            sidebar.style.display = 'block';
        })

        // Load past entries
        async function loadEntries() {
            const { data: entries, error } = await supabase
                .from('responses')
                .select('*')
                .eq('user_id', session.user.id)
                .order('created_at', { ascending: false })

            if (error) {
                console.error('Error loading entries:', error)
                return
            }

            // Group entries by question
            entries.forEach(entry => {
                const container = document.querySelector(`[data-question="${entry.prompt_id}"] .past-entries-sidebar .past-entries`)
                if (container) {
                    const entryEl = document.createElement('div')
                    entryEl.className = 'past-entry'
                    entryEl.innerHTML = `
                        <div class="entry-date">${new Date(entry.created_at).toLocaleDateString()}</div>
                        <div class="entry-content">${entry.content}</div>
                    `
                    container.appendChild(entryEl)
                }
            })
        }

        // Save new entry
        async function saveEntry(section, question, content) {
            console.log('saveEntry called with:', { section, question, content });
            console.log('Looking up prompt ID for:', question);
            console.log('Available promptIds:', promptIds);
            const promptId = promptIds[question];
            if (!promptId) {
                console.error('No prompt ID found for question:', question);
                console.error('Available questions:', Object.keys(promptIds));
                return false;
            }

            const { error } = await supabase
                .from('responses')
                .insert([
                    { 
                        content: content,
                        prompt_id: promptId,
                        user_id: session.user.id
                    }
                ])

            if (error) {
                console.error('Error saving entry:', {
                    message: error.message,
                    details: error.details,
                    hint: error.hint,
                    code: error.code
                });
                return false
            }

            return true
        }

        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add event listeners to save buttons
        document.querySelectorAll('.save-entry').forEach(button => {
            button.addEventListener('click', async () => {
                const journalEntry = button.closest('.journal-entry')
                const textarea = journalEntry.querySelector('textarea')
                const section = journalEntry.dataset.section
                // Find the original title from the slug
                const questionSlug = journalEntry.dataset.question
                const items = section === 'press_pause' ? pressPause : activateCuriosity
                const originalQuestion = items.find(item => item.title.toLowerCase().replace(/\s+/g, '-') === questionSlug)?.title
                
                if (!originalQuestion) {
                    console.error('Could not find original question for slug:', questionSlug)
                    return
                }

                const content = textarea.value.trim()

                if (content) {
                    const success = await saveEntry(section, originalQuestion, content)
                    if (success) {
                        // Add new entry to UI immediately
                        const pastEntriesContainer = document.querySelector(`[data-section="${section}"][data-question="${questionSlug}"] .past-entries-sidebar .past-entries`)
                        if (pastEntriesContainer) {
                            const entryEl = document.createElement('div')
                            entryEl.className = 'past-entry'
                            entryEl.innerHTML = `
                                <div class="entry-date">${new Date().toLocaleDateString()}</div>
                                <div class="entry-content">${escapeHtml(content)}</div>
                            `
                            // Insert at the top of the list
                            pastEntriesContainer.insertBefore(entryEl, pastEntriesContainer.firstChild)
                            textarea.value = ''
                        }
                    }
                }
            })
        })

        // Load entries on page load
        loadEntries()
    }
</script>

    </div>
    
    <footer class="site-footer">
        <span class="handshake">ü§ù</span>
        <p>a <a href="https://www.mutua.nyc">mutua.nyc</a> collaboration</p>
        <span class="handshake">ü§ù</span>
    </footer>

    <script type="module">
        import { AuthUI } from '/js/auth.js'
        
        const authButton = document.getElementById('authButton')
        const authModal = document.getElementById('authModal')
        const authContainer = document.getElementById('authContainer')
        
        let auth = null

        if (authButton) {
            authButton.addEventListener('click', async (e) => {
                e.preventDefault()
                e.stopPropagation()

                // If user is signed in, sign them out
                if (authButton.textContent === 'Sign Out') {
                    await supabase.auth.signOut()
                    authButton.textContent = 'Sign In'
                    // Don't show the auth modal after signing out
                    return
                }

                // Show sign in modal
                if (authModal) {
                    authModal.classList.add('visible')
                    authModal.classList.remove('hidden')
                    if (!auth) {
                        auth = AuthUI({ container: authContainer })
                    }
                }
            })
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (authModal && !authModal.contains(e.target) && !authButton.contains(e.target)) {
                authModal.classList.remove('visible')
                authModal.classList.add('hidden')
            }
        })

        // Prevent clicks inside modal from closing it
        if (authModal) {
            authModal.addEventListener('click', (e) => {
                e.stopPropagation()
            })
        }

        // Check auth state on page load and changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                // User is signed in
                // Hide the auth modal when signed in
                authModal.classList.remove('visible')
                authModal.classList.add('hidden')
                authButton.textContent = 'Sign Out'
                // Redirect to hearing voices page if on home page
                if (window.location.pathname === '/') {
                    window.location.href = '/hearing-voices';
                }
            } else {
                // User is signed out
                // Clear the auth UI when signed out
                auth = null
                authContainer.innerHTML = ''
                authButton.textContent = 'Sign In'
            }
        })

        // Initial check
        const { data: { session } } = await supabase.auth.getSession()
        if (session) {
            authButton.textContent = 'Sign Out'
            // Redirect to hearing voices page if on home page
            if (window.location.pathname === '/') {
                window.location.href = '/hearing-voices';
            }
        }
    </script>
</body>
</html> 